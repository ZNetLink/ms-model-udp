name: Release with Source Hash

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Package Source as ZIP and Calculate Hash
        id: package
        run: |
          # 1. èŽ·å–ç‰ˆæœ¬å· (ä¾‹å¦‚ v1.0.0)
          # github.ref_name åœ¨ tag è§¦å‘æ—¶å°±æ˜¯ tag åç§°
          VERSION=${{ github.ref_name }}
          FILENAME="source-code-${VERSION}.zip"
          
          # 2. æ‰“åŒ… ZIP
          git archive --format=zip --prefix="${{ github.event.repository.name }}-${VERSION}/" --output=$FILENAME HEAD
          
          # 3. è®¡ç®— SHA256
          HASH=$(sha256sum $FILENAME | awk '{print $1}')
          
          # 4. è¾“å‡ºç»“æžœ
          echo "FILENAME=$FILENAME" >> $GITHUB_OUTPUT
          echo "HASH=$HASH" >> $GITHUB_OUTPUT
          
          echo "Generated package: $FILENAME"
          echo "SHA256: $HASH"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.FILENAME }}
          generate_release_notes: true
          body: |
            ## ðŸ”’ Security Checksums
            
            | File | SHA256 Hash |
            | :--- | :--- |
            | [${{ steps.package.outputs.FILENAME }}](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.package.outputs.FILENAME }}) | `${{ steps.package.outputs.HASH }}` |
            
            ---
            (Auto-generated release notes below)